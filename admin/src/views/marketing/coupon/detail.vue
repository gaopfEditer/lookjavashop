<template>    <div class="coupon-detail">        <el-card class="!border-none" shadow="never">            <el-page-header :content="pageTitle" @back="handleRouteBack" />        </el-card>        <el-form            ref="formRef"            :model="formData"            label-width="120px"            :rules="rules"        >            <template v-for="(compItem, compIndex) in comLists" :key="compIndex">                <component :is="compItem.comp" :modelValue="formData" :disabled="readOnly"></component>            </template>        </el-form>        <footer-btns>            <el-button type="primary" @click="handleSave">保存</el-button>        </footer-btns>    </div></template><script lang="ts" setup name="CouponDetail">import type { FormInstance, FormRules } from 'element-plus'import { couponDetail, couponEdit, couponRename, couponAdd } from '@/api/marketing/coupon'import type { CouponFormParamsType } from '@/api/marketing/coupon.d'import useMultipleTabs from '@/hooks/useMultipleTabs'import Setting from './component/setting.vue'import Basic from './component/basic.vue'import Rule from './component/rule.vue'import feedback from '@/utils/feedback'const route = useRoute()const router = useRouter()const readOnly: any = route.query.read_onlyconst comLists = [    {        comp: markRaw(Basic)    },    {        comp: markRaw(Setting)    },    {        comp: markRaw(Rule)    }]const formData = reactive<CouponFormParamsType>({    id: '',             // id    conditionMoney: '',  // 使用条件(订单满多少可用)：condition_money=2时生效    conditionType: 1,   // 使用条件类型: 1=无门槛, 2=订单满足金额    getNum: '',         // 领取次数类型: get_type=2/3时生效    getNumType: 1,      // 领取次数类型: 1=不限制领取次数, 2=限制次数, 3=每天限制数量    getTimeEnd: '',     // 领取结束时间    getTimeStart: '',   // 领取开始时间    getType: 1,         // 领取限制类型: 1=用户领取, 2=商家赠送    money: '',          // 优惠券面额    name: '',           // 优惠券名称    sendTotal: '',      // 发放数量:  send_total_type=2时生效    sendTotalType: 2,   // 发放数量限制: 1=无限数量,2=固定发放数量    useGoodsList: [],    useGoodsIds: '',    // 使用商品ID, 多个时用逗号隔开, 如 1,2,4    useGoodsType: 1,    // 适用商品类型: 1=全部商品,2=指定商品,3=指定商品不可用    useTime: '',        // 多少天内可用: use_time_type=2/3时生效    useTimeEnd: '',     // 用券结束时间: use_time_type=1时生效    useTimeStart: '',   // 用券开始时间: use_time_type=1时生效    useTimeType: 1      // 用券时间类型: [1=固定时间, 2=领券当天起, 3=领券次日起]})const { removeTab } = useMultipleTabs()const formRef = shallowRef<FormInstance>()const rules = reactive<FormRules>({    name: [{ required: true, message: '请输入优惠券名称', trigger: 'change' }],    sendTotalType: [        { required: true, message: '请输入发放数量', trigger: 'change' },        {            validator: (rule: object, value: string, callback: any) => {                if (formData.sendTotalType == 2 && (formData.sendTotal == '' || formData.sendTotal < 0)) {                    if (formData.sendTotal == '') return callback(new Error('请输入发放数量'))                    if (formData.sendTotal < 0) return callback(new Error('发放数量不能为负数'))                }                callback()            },            trigger: 'blur'        }    ],    useGoodsType: [        { required: true, message: '请选择使用范围', trigger: 'change' },        {            validator: (rule: object, value: string, callback: any) => {                if (formData.useGoodsType != 1 && formData.useGoodsIds == '') {                    callback(new Error('请选择商品'))                }                callback()            },            trigger: 'blur'        }    ],    conditionType: [{ required: true, message: '请选择使用门槛', trigger: 'change' }],    money: [{ required: true, message: '请输入优惠券金额', trigger: 'change' }],    getType: [{ required: true, message: '请选择领取方式', trigger: 'change' }],    getTimeStart: [{ required: true, message: '请选择领券时间', trigger: 'change' }],    getNumType: [        { required: true, message: '请选择领取次数', trigger: 'change' },        {            validator: (rule: object, value: string, callback: any) => {                if (formData.getNumType == 2 &&(formData.getNum == '' || formData.getNum < 0)) {                    if (formData.getNum == '') return callback(new Error('请输入限制领取次数'))                    if (formData.getNum < 0) return callback(new Error('限制领取次数不能为负数'))                } else if (formData.getNumType == 3 && (formData.getNum == '' || formData.getNum < 0)) {                    if (formData.getNum == '') return callback(new Error('请输入每天限制领取次数'))                    if (formData.getNum < 0) return callback(new Error('每天限制领取次数不能为负数'))                }                callback()            },            trigger: 'blur'        }    ],    useTimeType: [        { required: true, message: '请选择用券时间', trigger: 'change' },        {            validator: (rule: object, value: string, callback: any) => {                if (formData.useTimeType == 1 && (!formData.useTimeStart || !formData.useTimeEnd)) {                    callback(new Error('请选择开始时间和结束用券时间'))                } else if (formData.useTimeType == 2 && (formData.useTime == '' || formData.useTime < 0)) {                    callback(new Error('请输入正确的领券次日起几天可用'))                } else if (formData.useTimeType == 3 && (formData.useTime == '' || formData.useTime < 0)) {                    callback(new Error('请输入正确的领券当日起几天内可用'))                }                callback()            },            trigger: 'blur'        }    ]})const pageTitle = computed(() => {    if (readOnly && route.query.id) {        return '优惠券详情'    } else if (route.query.id) {        return '编辑优惠券'    } else {        return '新增优惠券'    }})const getDetails = async () => {    const data = await couponDetail({        id: route.query.id as any    })    Object.keys(formData).forEach((key) => {        //@ts-ignore        formData[key] = data[key]    })}const handleSave = async () => {    try {        await formRef.value?.validate()        formData.useGoodsIds = formData.useGoodsIds.toString()        if (route.query.id && !readOnly) {            await couponEdit(formData)        } else if (!route.query.id && !readOnly){            await couponAdd(formData)        } else if (route.query.id && readOnly) {            await couponRename({                id: route.query.id,                name: formData.name,                sendTotal: formData.sendTotal            })        }        handleRouteBack()    } catch (error) {        console.log('保存秒杀报错', error)    }}const handleRouteBack = () => {    removeTab()    router.back()}onMounted(() => {    route.query.id && getDetails()})</script>